<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï¢ÖÌï© ÏûêÏÇ∞ Î™®ÎãàÌÑ∞ÎßÅ</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            /* Unified to white */
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 40%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            padding: 1rem 0;
            /* Reduced padding */
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            font-size: 1.25rem;
            /* Reduced font size 2.5->1.25 */
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .container {
            width: 95%;
            max-width: 1800px;
            margin: 1rem auto;
            flex: 1;
            display: flex;
            /* Changed from default to flex column */
            flex-direction: column;
        }

        .scroll-container {
            overflow-x: auto;
            /* Horizontal scroll ONLY here */
            width: 100%;
            padding-bottom: 2rem;
            /* display: flex; REMOVED to avoid flex conflict with max-content grid */
        }

        .grid-layout {
            display: flex;
            /* Flex row */
            flex-wrap: nowrap;
            /* No wrapping */
            gap: 1.5rem;
            width: max-content;
            /* Ensure container grows */
            padding: 0 1rem;
            min-height: 200px;
            /* Ensure visibility */
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            width: 600px;
            /* Fixed width for horizontal items */
            min-width: 600px;
            height: auto;
            /* Fallback to auto if flex is tricky */
            max-height: 80vh;
            /* Limit height */
        }

        .card-header {
            padding: 0.75rem;
            /* Reduced padding */
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        .card-header h2 {
            margin: 0;
            font-size: 1rem;
            /* Reduced font size */
            color: var(--text-primary);
        }

        .loader {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5rem;
            text-align: center;
            grid-column: 1 / -1;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-msg {
            color: #ef4444;
            padding: 1rem;
            text-align: center;
            grid-column: 1 / -1;
        }

        .table-container {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.75rem;
            /* Reduced base font size */
        }

        th,
        td {
            padding: 0.35rem 0.5rem;
            /* Reduced padding for half height */
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(255, 255, 255, 0.03);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.75rem;
            /* Reduced header font size */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        tr {
            transition: background 0.2s;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .weight-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
            width: 80px;
        }

        .weight-fill {
            height: 100%;
            background: linear-gradient(90deg, #38bdf8, #818cf8);
            border-radius: 2px;
        }

        .refresh-btn {
            margin-bottom: 1rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4);
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(56, 189, 248, 0.6);
        }
    </style>
</head>

<body>

    <header>
        <h1>Ï¢ÖÌï© ÏûêÏÇ∞ Î™®ÎãàÌÑ∞ÎßÅ <span style="font-size: 0.6em; opacity: 0.7;">v1.2</span></h1>
        <p id="status-line" style="color: var(--text-primary); margin-top: 0.5rem;">Real-time Constituent Holdings</p>
        <nav style="margin-top: 0.8rem; display: flex; gap: 1rem; justify-content: center;">
            <a href="/living.html" style="color: #fff; text-decoration: none; padding: 0.5rem 1.2rem; background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%); border-radius: 10px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 12px rgba(56,189,248,0.3);">ÏÉùÌôúÎπÑ Í¥ÄÎ¶¨</a>
        </nav>
    </header>

    <div class="container">
        <div style="text-align: right;">
            <button class="refresh-btn" onclick="fetchData()">Refresh Data</button>
        </div>

        <!-- Total Portfolio Section (Vertical, Full Height) -->
        <div id="total-section" style="display: flex; justify-content: center; margin-bottom: 2rem;"></div>

        <!-- ETF Grid Section (Horizontal Scroll) -->
        <div class="scroll-container">
            <div id="grid" class="grid-layout">
                <div id="loading" class="loader">
                    <div class="spinner"></div>
                    <p>Fetching real-time data from ETF providers...</p>
                    <small style="color: var(--text-primary); margin-top: 0.5rem;">Connecting to ACE and
                        TIGER...</small>
                </div>
                <div id="error" class="error-msg" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        async function fetchData() {
            const grid = document.getElementById('grid');
            const totalSection = document.getElementById('total-section');
            const statusLine = document.getElementById('status-line');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');

            // Reset UI for refresh
            grid.innerHTML = '';
            totalSection.innerHTML = ''; // Clear total section
            grid.appendChild(loading);
            grid.appendChild(error); // Keep error hidden

            loading.style.display = 'flex';
            error.style.display = 'none';
            statusLine.textContent = "Fetching data...";

            try {
                const response = await fetch('/api/constituents');
                const result = await response.json();

                // Remove loader
                loading.style.display = 'none';

                if (result.success) {
                    statusLine.textContent = `Rendering ${result.data.length} items...`;

                    // --- Aggregation Logic Start ---
                    const aggregates = {};
                    let globalTotal = 0;

                    result.data.forEach(etf => {
                        const components = etf.components || [];
                        components.forEach(item => {
                            let code = item.code;
                            let name = item.name;
                            const amountStr = item.amount;
                            if (!amountStr || amountStr === '-') return;

                            // Parse "1,234,567Ïõê" -> 1234567
                            const amount = parseInt(amountStr.replace(/[^0-9]/g, ''), 10);
                            if (isNaN(amount)) return;

                            // Special Aggregation for "Íµ≠Í≥†Ï±ÑÍ∂å" & US Treasuries (T 4, T 3) & TIGER Ï§ëÏû•Í∏∞Íµ≠Ï±Ñ
                            const codeTrimmed = code.trim();
                            const nameLower = name.toLowerCase();

                            const hasDate = /\d{4}[.\-\/]\d{2}[.\-\/]?\d{0,2}/.test(name) || /\d{2}[.\-\/]\d{2}[.\-\/]\d{2,4}/.test(name) || /\d{8}/.test(name) || /(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\d{2}/i.test(name);
                            const hasGovt = nameLower.includes('government');
                            if (hasDate || hasGovt || codeTrimmed.startsWith('Íµ≠Í≥†') || name.startsWith('Íµ≠Í≥†') || codeTrimmed.startsWith('T 4') || codeTrimmed.startsWith('T 3') || name.includes('TIGER') && name.includes('Íµ≠Ï±Ñ')) {
                                code = 'Ï±ÑÍ∂å';
                                name = 'Ï±ÑÍ∂å ÌÜµÌï© (Bond Aggregated)';
                            }
                            // Special Aggregation for GOOGL (Alphabet Inc.)
                            else if (codeTrimmed === 'GOOGL' || codeTrimmed === 'GOOG' || nameLower.includes('alphabet') || nameLower.includes('google')) {
                                code = 'GOOGL';
                                name = 'Alphabet Inc. (GOOGL Ìï©ÏÇ∞)';
                            }

                            if (!aggregates[code]) {
                                aggregates[code] = {
                                    code: code,
                                    name: name,
                                    totalAmount: 0
                                };
                            }
                            aggregates[code].totalAmount += amount;
                            globalTotal += amount;
                        });
                    });

                    // Sort by total amount desc
                    const sortedAggregates = Object.values(aggregates).sort((a, b) => b.totalAmount - a.totalAmount);

                    if (sortedAggregates.length > 0) {
                        const totalCard = document.createElement('div');
                        totalCard.className = 'card';
                        totalCard.style.border = '1px solid var(--accent)';
                        totalCard.style.height = 'auto';
                        totalCard.style.maxHeight = 'none';
                        totalCard.style.width = '100%';
                        totalCard.style.minWidth = 'auto';
                        totalCard.style.overflow = 'visible';

                        // Split into columns of 33 items each
                        const ITEMS_PER_COL = 33;
                        const columns = [];
                        for (let i = 0; i < sortedAggregates.length; i += ITEMS_PER_COL) {
                            columns.push(sortedAggregates.slice(i, i + ITEMS_PER_COL));
                        }
                        totalCard.style.maxWidth = '100%';

                        const generateRows = (items, startIndex) => items.map((item, idx) => {
                            const index = startIndex + idx;
                            const weight = globalTotal > 0 ? ((item.totalAmount / globalTotal) * 100).toFixed(2) : '0';
                            const amountStr = item.totalAmount.toLocaleString('ko-KR') + "Ïõê";
                            return `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><span class="tag" style="background: rgba(139, 92, 246, 0.2); border-color: rgba(139, 92, 246, 0.4); color: #fff;">${item.code}</span></td>
                                    <td style="font-weight: 500;">${item.name}</td>
                                    <td>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>${weight}%</span>
                                            <span style="color: var(--text-primary); font-size: 0.85em; font-weight: bold;">${amountStr}</span>
                                        </div>
                                        <div class="weight-bar">
                                            <div class="weight-fill" style="width: ${Math.min(parseFloat(weight) * 5, 100)}%; background: linear-gradient(90deg, #8b5cf6, #d946ef);"></div>
                                        </div>
                                    </td>
                                </tr>`;
                        }).join('');

                        const tableTemplate = (rows) => `
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">No</th>
                                        <th>Code</th>
                                        <th>Name</th>
                                        <th style="width: 200px;">Weight / Amount</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>`;

                        const columnsHtml = columns.map((colItems, colIdx) => {
                            const rowsHtml = generateRows(colItems, colIdx * ITEMS_PER_COL);
                            return `<div class="table-container" style="min-width: 650px; flex: 0 0 650px;">${tableTemplate(rowsHtml)}</div>`;
                        }).join('');

                        // Calculate category ratios
                        const bondAmount = aggregates['Ï±ÑÍ∂å']?.totalAmount || 0;
                        const savingsAmount = aggregates['ÏòàÏ†ÅÍ∏à']?.totalAmount || 0;
                        const cashAmount = aggregates['ÏõêÌôîÌòÑÍ∏à']?.totalAmount || 0;
                        const stockAmount = globalTotal - bondAmount - savingsAmount - cashAmount;

                        const stockRatio = globalTotal > 0 ? ((stockAmount / globalTotal) * 100).toFixed(1) : '0';
                        const bondRatio = globalTotal > 0 ? ((bondAmount / globalTotal) * 100).toFixed(1) : '0';
                        const savingsRatio = globalTotal > 0 ? ((savingsAmount / globalTotal) * 100).toFixed(1) : '0';
                        const cashRatio = globalTotal > 0 ? ((cashAmount / globalTotal) * 100).toFixed(1) : '0';

                        const s1 = parseFloat(stockRatio);
                        const s2 = s1 + parseFloat(bondRatio);
                        const s3 = s2 + parseFloat(savingsRatio);

                        totalCard.innerHTML = `
                            <div class="card-header" style="background: rgba(139, 92, 246, 0.1);">
                                <h2>üî• Total Portfolio <span style="font-size: 0.8em; color: var(--accent);">(${globalTotal.toLocaleString('ko-KR')}Ïõê)</span></h2>
                                <div style="display: flex; align-items: center; gap: 1.5rem; margin-top: 0.5rem;">
                                    <div style="width: 180px; height: 180px; border-radius: 50%; flex-shrink: 0; background: conic-gradient(#10b981 0% ${s1}%, #f59e0b ${s1}% ${s2}%, #a78bfa ${s2}% ${s3}%, #60a5fa ${s3}% 100%); position: relative;">
                                        ${[
                                            {label: 'Ï£ºÏãù', ratio: stockRatio, start: 0, end: s1, color: '#fff'},
                                            {label: 'Ï±ÑÍ∂å', ratio: bondRatio, start: s1, end: s2, color: '#fff'},
                                            {label: 'ÏòàÏ†ÅÍ∏à', ratio: savingsRatio, start: s2, end: s3, color: '#fff'},
                                            {label: 'ÌòÑÍ∏à', ratio: cashRatio, start: s3, end: 100, color: '#fff'}
                                        ].filter(s => (s.end - s.start) >= 3).map(s => {
                                            const midAngle = ((s.start + s.end) / 2 / 100) * 360 - 90;
                                            const rad = midAngle * Math.PI / 180;
                                            const r = 55;
                                            const x = 90 + r * Math.cos(rad);
                                            const y = 90 + r * Math.sin(rad);
                                            return '<div style="position:absolute;left:' + x + 'px;top:' + y + 'px;transform:translate(-50%,-50%);font-size:0.55em;font-weight:bold;color:' + s.color + ';text-shadow:0 0 3px rgba(0,0,0,0.7);white-space:nowrap;pointer-events:none;">' + s.label + '<br>' + s.ratio + '%</div>';
                                        }).join('')}
                                    </div>
                                    <div style="font-size: 0.85em; display: flex; flex-direction: column; gap: 0.4rem;">
                                        <span style="color: #10b981;">&#9632; Ï£ºÏãù: <strong>${stockRatio}%</strong> (${stockAmount.toLocaleString('ko-KR')}Ïõê)</span>
                                        <span style="color: #f59e0b;">&#9632; Ï±ÑÍ∂å: <strong>${bondRatio}%</strong> (${bondAmount.toLocaleString('ko-KR')}Ïõê)</span>
                                        <span style="color: #a78bfa;">&#9632; ÏòàÏ†ÅÍ∏à: <strong>${savingsRatio}%</strong> (${savingsAmount.toLocaleString('ko-KR')}Ïõê)</span>
                                        <span style="color: #60a5fa;">&#9632; ÌòÑÍ∏à: <strong>${cashRatio}%</strong> (${cashAmount.toLocaleString('ko-KR')}Ïõê)</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-wrap: nowrap; gap: 1rem; padding: 0.5rem; overflow-x: auto;">
                                ${columnsHtml}
                            </div>
                        `;
                        // Append to the dedicated Total Section
                        totalSection.appendChild(totalCard);
                    }
                    // --- Aggregation Logic End ---

                    result.data.forEach(etf => {
                        const card = document.createElement('div');
                        card.className = 'card';

                        const rows = (etf.components || []).map(item => `
                            <tr>
                                <td>${item.no}</td>
                                <td><span class="tag">${item.code}</span></td>
                                <td style="font-weight: 500;">
                                    ${item.name}
                                </td>
                                <td>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>${item.weight}%</span>
                                        <span style="color: var(--text-primary); font-size: 0.85em;">${item.amount !== '-' ? item.amount : ''}</span>
                                    </div>
                                    <div class="weight-bar">
                                        <div class="weight-fill" style="width: ${Math.min(parseFloat(item.weight) * 5, 100)}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `).join('');

                        card.innerHTML = `
                            <div class="card-header">
                                <h2>${etf.title}</h2>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">No</th>
                                            <th>Code</th>
                                            <th>Name</th>
                                            <th style="width: 250px;">Weight / Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rows}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        grid.appendChild(card);
                    });

                    statusLine.textContent = `Completed: ${result.data.length} items loaded.`;
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                loading.style.display = 'none';
                error.textContent = 'Failed to load data: ' + err.message;
                error.style.display = 'block';
                grid.appendChild(error);
                statusLine.textContent = "Error occurred.";
            }
        }

        // Initial load
        window.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>

</html>